---
import Layout from '../layouts/Layout.astro'

interface Category {
    name: string
}

interface ArticleData {
    id: string
    title: string
    authors: { username: string }[]
    content: string
    views: string
    summary: string
    categories: Category[]
    thumb: string
    description?: string
}

interface Article {
    success: boolean
    data: ArticleData
}

const id = Astro.params.id
let article: Article | null = null

try {
    const response = await fetch(`https://cms.2077.xyz/api/articles/${id}`)
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
    }
    const data = await response.json()

    if (data && data.success && data.data) {
        article = data as Article
    } else {
        throw new Error('Invalid article data')
    }
} catch (error) {
    console.error('Error fetching article:', error)
}
---

<Layout
    title={article?.data?.title ?? ''}
    description={article?.data?.summary ?? ''}
>
    <main class="max-w-screen-3xl m-auto">
        <article class="pt-8 px-6 lg:px-32">
            <a href="/">Back</a>
            {
                article ? (
                    <article>
                        <div>
                            <ul class="flex gap-x-2">
                                {article.data?.categories.map(
                                    (category: { name: string }) => (
                                        <li>
                                            <a
                                                href={`/categories/${category.name}`}
                                            >
                                                {category.name}
                                            </a>
                                        </li>
                                    ),
                                )}
                            </ul>
                            <h1>{article.data?.title}</h1>
                            <p>{article.data?.summary}</p>

                            <div class="flex justify-center py-8">
                                <img
                                    src={`${article.data?.thumb}`}
                                    alt=""
                                    width="1024"
                                    height="682"
                                />
                            </div>
                            <div
                                class="max-w-screen-lg m-auto flex flex-col gap-y-4 mb-32"
                                set:html={article.data?.content.replace(
                                    /<hr\s*\/?>/g,
                                    '',
                                )}
                            />
                        </div>
                    </article>
                ) : (
                    <p>
                        {article === null
                            ? 'Error loading article. Please try again.'
                            : 'Article not found.'}
                    </p>
                )
            }
        </article>
    </main>
</Layout>

<style>
    p {
        padding-block-end: 2rem;
    }
</style>
